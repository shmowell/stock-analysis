{% extends "base.html" %}
{% block title %}Scores - Stock Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Stock Scores</h1>
    <div class="page-actions">
        <button id="btn-recalc" class="btn btn-primary" onclick="startCalc({})">Recalculate All</button>
        <a href="/scores/report" class="btn btn-secondary">View Report</a>
    </div>
</div>

<div id="calc-toast" class="toast" style="display:none;">
    <div class="spinner spinner-small"></div>
    <span id="calc-toast-msg">Calculating...</span>
</div>

{% if calc_date %}
<p class="text-muted">Calculated: {{ calc_date }}</p>
{% endif %}

{% if scores %}
<table class="table">
    <thead>
        <tr>
            <th>Rank</th>
            <th>Ticker</th>
            <th>Recommendation</th>
            <th>Composite</th>
            <th>Fundamental</th>
            <th>Technical</th>
            <th>Sentiment</th>
            <th>Change</th>
        </tr>
    </thead>
    <tbody>
        {% for s in scores %}
        {% set prev = previous.get(s.ticker, {}) %}
        {% set chg = (s.final_composite_score|float - prev.get('composite_score', s.final_composite_score|float))|round(1) if s.final_composite_score is not none else 0 %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>
                <a href="/scores/{{ s.ticker }}">{{ s.ticker }}</a>
                {% if data_statuses and s.ticker in data_statuses %}
                <span class="badge badge-warn" title="Missing data for some pillars">!</span>
                {% endif %}
            </td>
            <td><span class="rec rec-{{ s.recommendation|lower|replace(' ', '-') }}">{{ s.recommendation }}</span></td>
            <td>{{ "%.1f"|format(s.final_composite_score|float) if s.final_composite_score is not none else "N/A" }}</td>
            <td>{{ "%.1f"|format(s.fundamental_score|float) if s.fundamental_score is not none else "N/A" }}</td>
            <td>{{ "%.1f"|format(s.technical_score|float) if s.technical_score is not none else "N/A" }}</td>
            <td>{{ "%.1f"|format(s.sentiment_score|float) if s.sentiment_score is not none else "N/A" }}</td>
            <td class="{% if chg > 0 %}text-green{% elif chg < 0 %}text-red{% endif %}">
                {% if chg != 0 %}{{ "%+.1f"|format(chg) }}{% endif %}
            </td>
        </tr>
        {% endfor %}
        {% for s in unscored|default([]) %}
        <tr class="row-unscored">
            <td class="text-muted">--</td>
            <td>
                <a href="/scores/{{ s.ticker }}">{{ s.ticker }}</a>
                <span class="badge badge-warn" title="Insufficient data for scoring">!</span>
            </td>
            <td><span class="rec rec-insufficient-data">INSUFFICIENT DATA</span></td>
            <td class="text-muted">N/A</td>
            <td class="text-muted">N/A</td>
            <td class="text-muted">N/A</td>
            <td class="text-muted">N/A</td>
            <td></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">No scores available. Run the scoring pipeline first.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function startCalc(opts) {
    var btn = document.getElementById('btn-recalc');
    btn.disabled = true;
    btn.textContent = 'Running...';

    var toast = document.getElementById('calc-toast');
    var toastMsg = document.getElementById('calc-toast-msg');
    toast.style.display = 'flex';
    toastMsg.textContent = opts.ticker
        ? 'Refreshing ' + opts.ticker + '...'
        : 'Recalculating all scores...';

    fetch('/scores/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(opts)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        pollTask(data.task_id);
    })
    .catch(function(err) {
        toastMsg.textContent = 'Error: ' + err;
        toast.className = 'toast toast-error';
        btn.disabled = false;
        btn.textContent = 'Recalculate All';
    });
}

function pollTask(taskId) {
    var toast = document.getElementById('calc-toast');
    var toastMsg = document.getElementById('calc-toast-msg');

    fetch('/api/task/' + taskId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'completed') {
                toast.className = 'toast toast-success';
                toastMsg.textContent = data.result || 'Done!';
                toast.querySelector('.spinner').style.display = 'none';
                setTimeout(function() { window.location.reload(); }, 1000);
            } else if (data.status === 'failed') {
                toast.className = 'toast toast-error';
                toastMsg.textContent = 'Failed: ' + (data.error || 'Unknown error');
                toast.querySelector('.spinner').style.display = 'none';
                var btn = document.getElementById('btn-recalc');
                btn.disabled = false;
                btn.textContent = 'Recalculate All';
            } else {
                setTimeout(function() { pollTask(taskId); }, 2000);
            }
        })
        .catch(function() {
            setTimeout(function() { pollTask(taskId); }, 3000);
        });
}
</script>
{% endblock %}
