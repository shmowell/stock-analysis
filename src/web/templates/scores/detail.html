{% extends "base.html" %}
{% block title %}{{ stock.ticker }} - Stock Analysis{% endblock %}

{% macro score_bar(label, value, css_class='', weight='', explanation='') %}
<div class="score-bar-row sub-score-bar-row">
    <span class="score-label">{{ label }}{% if weight %} <span class="text-muted">({{ weight }})</span>{% endif %}</span>
    <div class="score-bar-track">
        {% if value is not none %}
        <div class="score-bar-fill {{ css_class }}" style="width: {{ value|float }}%"></div>
        {% endif %}
    </div>
    {% if value is not none %}
    <span class="score-value">{{ "%.1f"|format(value|float) }}</span>
    {% else %}
    <span class="score-value score-none">--</span>
    {% endif %}
</div>
{% if explanation %}
<p class="score-explanation">{{ explanation }}</p>
{% endif %}
{% endmacro %}

{% block content %}
<div class="page-header">
    <h1>{{ stock.ticker }} â€” {{ stock.company_name or '' }}</h1>
    <div class="page-actions">
        <button id="btn-recalc" class="btn btn-primary" onclick="startCalc()">Recalculate {{ stock.ticker }}</button>
        <a href="/overrides/apply?ticker={{ stock.ticker }}" class="btn btn-secondary">Apply Override</a>
    </div>
</div>

<div id="calc-toast" class="toast" style="display:none;">
    <div class="spinner spinner-small"></div>
    <span id="calc-toast-msg">Calculating...</span>
</div>

<p class="text-muted">{{ stock.sector or '' }} | {{ stock.industry or '' }}
    {% if stock.market_cap %}
        | ${{ "%.1f"|format(stock.market_cap|float / 1e9) }}B
    {% endif %}
</p>

{% if data_status and 'no_data' in data_status.values() %}
<div class="flash flash-warning data-warning">
    <strong>Data gaps detected</strong> &mdash;
    {% for pillar, status in data_status.items() %}
        {% if status == 'no_data' %}
        <span>{{ pillar|capitalize }} (no data)</span>{% if not loop.last %}, {% endif %}
        {% endif %}
    {% endfor %}
    <br><span class="text-muted">Run data collection to populate missing pillars. Unscored pillars are excluded from composite ranking.</span>
</div>
{% endif %}

{# Price + Composite + Pillar row #}
{% if score %}
<div class="detail-grid detail-grid-3">
    <div class="card">
        <h2>Price</h2>
        <div id="price-display">
            <span class="text-muted" style="font-size:13px;">Loading...</span>
        </div>
    </div>

    <div class="card">
        <h2>Composite Score</h2>
        {% if score.final_composite_score is not none %}
        <div class="big-number">{{ "%.1f"|format(score.final_composite_score|float) }}</div>
        <p><span class="rec rec-{{ score.recommendation|lower|replace(' ', '-') }}">{{ score.recommendation }}</span></p>
        {% else %}
        <div class="big-number score-none">N/A</div>
        <p><span class="rec rec-insufficient-data">INSUFFICIENT DATA</span></p>
        {% endif %}
        {% if score.calculation_date %}
        <p class="text-muted">Calculated: {{ score.calculation_date }}</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>Pillar Scores</h2>
        <div class="score-bars">
            <div class="score-bar-row">
                <span class="score-label">Fundamental (45%)</span>
                <div class="score-bar-track">
                    {% if score.fundamental_score is not none %}
                    <div class="score-bar-fill" style="width: {{ score.fundamental_score|float }}%"></div>
                    {% endif %}
                </div>
                {% if score.fundamental_score is not none %}
                <span class="score-value">{{ "%.1f"|format(score.fundamental_score|float) }}</span>
                {% else %}
                <span class="score-value score-none">N/A</span>
                {% endif %}
            </div>
            <div class="score-bar-row">
                <span class="score-label">Technical (35%)</span>
                <div class="score-bar-track">
                    {% if score.technical_score is not none %}
                    <div class="score-bar-fill score-bar-tech" style="width: {{ score.technical_score|float }}%"></div>
                    {% endif %}
                </div>
                {% if score.technical_score is not none %}
                <span class="score-value">{{ "%.1f"|format(score.technical_score|float) }}</span>
                {% else %}
                <span class="score-value score-none">N/A</span>
                {% endif %}
            </div>
            <div class="score-bar-row">
                <span class="score-label">Sentiment (20%)</span>
                <div class="score-bar-track">
                    {% if score.sentiment_score is not none %}
                    <div class="score-bar-fill score-bar-sent" style="width: {{ score.sentiment_score|float }}%"></div>
                    {% endif %}
                </div>
                {% if score.sentiment_score is not none %}
                <span class="score-value">{{ "%.1f"|format(score.sentiment_score|float) }}</span>
                {% else %}
                <span class="score-value score-none">N/A</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Charts row #}
<div class="detail-grid">
    <div class="card">
        <h2>Price History (6 months)</h2>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h2>Score Trends</h2>
        <div class="chart-container">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>
</div>

{# Score vs. Price Performance #}
<div class="detail-grid" style="grid-template-columns:1fr;">
    <div class="card">
        <h2>Score vs. Price Performance</h2>
        <p id="perf-summary" class="text-muted" style="font-size:13px;">Loading performance data...</p>
        <div class="chart-container">
            <canvas id="perfChart"></canvas>
        </div>
        <p class="text-muted" style="font-size:12px; margin-top:0.5rem;">
            Line = composite score at each snapshot. Bars = actual 1-month forward return after that score was assigned.
            <a href="/performance/" class="link-small">View universe-wide analysis</a>
        </p>
    </div>
</div>

{# Sub-component breakdown cards #}
{% set expl = explanations or {} %}
<div class="detail-grid">
    {# Fundamental Breakdown #}
    <div class="card">
        <h2>Fundamental Breakdown</h2>
        {% set fund = sub_components.get('fundamental', {}) if sub_components else {} %}
        {% set fund_expl = expl.get('fundamental', {}) %}
        {% if data_status.get('fundamental') == 'no_data' %}
        <p class="score-none">No fundamental data available for this stock.</p>
        {% elif fund %}
        <div class="score-bars">
            {{ score_bar('Value', fund.get('value_score'), '', '33%', fund_expl.get('value')) }}
            {{ score_bar('Quality', fund.get('quality_score'), '', '33%', fund_expl.get('quality')) }}
            {{ score_bar('Growth', fund.get('growth_score'), '', '34%', fund_expl.get('growth')) }}
        </div>
        {% else %}
        <p class="text-muted">No breakdown data available.</p>
        {% endif %}
    </div>

    {# Technical Breakdown #}
    <div class="card">
        <h2>Technical Breakdown</h2>
        {% set tech = sub_components.get('technical', {}) if sub_components else {} %}
        {% set tech_expl = expl.get('technical', {}) %}
        {% if data_status.get('technical') == 'no_data' %}
        <p class="score-none">No technical data available for this stock.</p>
        {% elif tech %}
        <div class="score-bars">
            {{ score_bar('Momentum', tech.get('momentum_score'), 'score-bar-tech', '35%', tech_expl.get('momentum')) }}
            {{ score_bar('Trend', tech.get('trend_score'), 'score-bar-tech', '25%', tech_expl.get('trend')) }}
            {{ score_bar('Volume-Qual', tech.get('volume_qualified_score'), 'score-bar-tech', '20%', tech_expl.get('volume_qualified')) }}
            {{ score_bar('Rel Strength', tech.get('relative_strength_score'), 'score-bar-tech', '10%', tech_expl.get('relative_strength')) }}
            {{ score_bar('RSI', tech.get('rsi_score'), 'score-bar-tech', '5%', tech_expl.get('rsi')) }}
            {{ score_bar('Multi-Speed', tech.get('multi_speed_score'), 'score-bar-tech', '5%', tech_expl.get('multi_speed')) }}
        </div>
        {% else %}
        <p class="text-muted">No breakdown data available.</p>
        {% endif %}
    </div>

    {# Sentiment Breakdown #}
    <div class="card">
        <h2>Sentiment Breakdown</h2>
        {% set sent = sub_components.get('sentiment', {}) if sub_components else {} %}
        {% set sent_expl = expl.get('sentiment', {}) %}
        {% if data_status.get('sentiment') == 'no_data' %}
        <p class="score-none">No sentiment data available for this stock.</p>
        {% elif sent %}
        <div class="score-bars">
            {{ score_bar('Market Sentiment', sent.get('market_sentiment'), 'score-bar-sent', '40%', sent_expl.get('market')) }}
            {{ score_bar('Stock Sentiment', sent.get('stock_sentiment'), 'score-bar-sent', '60%', sent_expl.get('stock')) }}
        </div>
        <h3 class="sub-section-header">Stock Sentiment Detail</h3>
        <div class="score-bars">
            {{ score_bar('Short Interest', sent.get('short_interest_score'), 'score-bar-sent', '', sent_expl.get('short_interest')) }}
            {{ score_bar('Analyst Revision', sent.get('revision_score'), 'score-bar-sent', '', sent_expl.get('revision')) }}
            {{ score_bar('Analyst Consensus', sent.get('consensus_score'), 'score-bar-sent', '', sent_expl.get('consensus')) }}
            {{ score_bar('Insider Activity', sent.get('insider_score'), 'score-bar-sent', '', sent_expl.get('insider')) }}
        </div>
        {% else %}
        <p class="text-muted">No breakdown data available.</p>
        {% endif %}
    </div>
</div>
{% else %}
<p class="text-muted">No score data available for this stock.</p>
{% endif %}

<a href="/scores/" class="link-small">Back to all scores</a>
{% endblock %}

{% block scripts %}
<script>
var TICKER = "{{ stock.ticker }}";

/* ---------- Recalculate button ---------- */
function startCalc() {
    var btn = document.getElementById('btn-recalc');
    btn.disabled = true;
    btn.textContent = 'Running...';

    var toast = document.getElementById('calc-toast');
    var toastMsg = document.getElementById('calc-toast-msg');
    toast.style.display = 'flex';
    toastMsg.textContent = 'Refreshing data for ' + TICKER + '...';

    fetch('/scores/calculate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ticker: TICKER})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) { pollTask(data.task_id); })
    .catch(function(err) {
        toastMsg.textContent = 'Error: ' + err;
        toast.className = 'toast toast-error';
        btn.disabled = false;
        btn.textContent = 'Recalculate ' + TICKER;
    });
}

function pollTask(taskId) {
    var toast = document.getElementById('calc-toast');
    var toastMsg = document.getElementById('calc-toast-msg');

    fetch('/api/task/' + taskId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'completed') {
                toast.className = 'toast toast-success';
                toastMsg.textContent = data.result || 'Done!';
                toast.querySelector('.spinner').style.display = 'none';
                setTimeout(function() { window.location.reload(); }, 1000);
            } else if (data.status === 'failed') {
                toast.className = 'toast toast-error';
                toastMsg.textContent = 'Failed: ' + (data.error || 'Unknown error');
                toast.querySelector('.spinner').style.display = 'none';
                var btn = document.getElementById('btn-recalc');
                btn.disabled = false;
                btn.textContent = 'Recalculate ' + TICKER;
            } else {
                setTimeout(function() { pollTask(taskId); }, 2000);
            }
        })
        .catch(function() {
            setTimeout(function() { pollTask(taskId); }, 3000);
        });
}

/* ---------- Charts ---------- */
fetch('/scores/' + TICKER + '/chart-data')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        renderPrice(data.price);
        renderPriceChart(data.price);
        renderScoreChart(data.scores);
    })
    .catch(function(err) {
        document.getElementById('price-display').innerHTML =
            '<span class="text-muted">Price data unavailable</span>';
    });

function renderPrice(price) {
    var el = document.getElementById('price-display');
    if (!price || !price.current) {
        el.innerHTML = '<span class="text-muted">No price data</span>';
        return;
    }
    var positive = price.change_1d >= 0;
    var sign = positive ? '+' : '';
    var colorClass = positive ? 'text-green' : 'text-red';
    el.innerHTML =
        '<div class="price-current">$' + price.current.toFixed(2) + '</div>' +
        '<div class="price-change ' + colorClass + '">' +
            sign + price.change_1d.toFixed(2) +
            ' (' + sign + price.change_1d_pct.toFixed(2) + '%)' +
        '</div>';
}

function renderPriceChart(price) {
    var canvas = document.getElementById('priceChart');
    if (!canvas || !price || !price.dates || price.dates.length === 0) return;

    new Chart(canvas, {
        type: 'line',
        data: {
            labels: price.dates,
            datasets: [{
                label: TICKER + ' Close',
                data: price.closes,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37,99,235,0.08)',
                fill: true,
                borderWidth: 2,
                pointRadius: 0,
                pointHitRadius: 8,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) { return '$' + ctx.parsed.y.toFixed(2); }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 6,
                        callback: function(val, i) {
                            var d = this.getLabelForValue(val);
                            return d.substring(5); /* MM-DD */
                        }
                    },
                    grid: { display: false }
                },
                y: {
                    ticks: {
                        callback: function(val) { return '$' + val; }
                    }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}

function renderScoreChart(scores) {
    var canvas = document.getElementById('scoreChart');
    if (!canvas || !scores || !scores.dates || scores.dates.length === 0) {
        if (canvas) {
            canvas.parentNode.innerHTML =
                '<p class="text-muted" style="padding:1rem;">Score history will appear as more calculations are recorded.</p>';
        }
        return;
    }

    new Chart(canvas, {
        type: 'line',
        data: {
            labels: scores.dates,
            datasets: [
                {
                    label: 'Composite',
                    data: scores.composite,
                    borderColor: '#1a1d23',
                    borderWidth: 2.5,
                    pointRadius: scores.dates.length <= 10 ? 4 : 0,
                    pointHitRadius: 8,
                    tension: 0.2
                },
                {
                    label: 'Fundamental',
                    data: scores.fundamental,
                    borderColor: '#2563eb',
                    borderWidth: 1.5,
                    pointRadius: scores.dates.length <= 10 ? 3 : 0,
                    pointHitRadius: 8,
                    borderDash: [4, 2],
                    tension: 0.2
                },
                {
                    label: 'Technical',
                    data: scores.technical,
                    borderColor: '#8b5cf6',
                    borderWidth: 1.5,
                    pointRadius: scores.dates.length <= 10 ? 3 : 0,
                    pointHitRadius: 8,
                    borderDash: [4, 2],
                    tension: 0.2
                },
                {
                    label: 'Sentiment',
                    data: scores.sentiment,
                    borderColor: '#06b6d4',
                    borderWidth: 1.5,
                    pointRadius: scores.dates.length <= 10 ? 3 : 0,
                    pointHitRadius: 8,
                    borderDash: [4, 2],
                    tension: 0.2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 10, font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) { return ctx.dataset.label + ': ' + (ctx.parsed.y !== null ? ctx.parsed.y.toFixed(1) : 'N/A'); }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { maxTicksLimit: 8 },
                    grid: { display: false }
                },
                y: {
                    min: 0,
                    max: 100,
                    ticks: { stepSize: 25 }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}

/* ---------- Score vs. Performance Chart ---------- */
fetch('/performance/stock/' + TICKER)
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) {
            document.getElementById('perf-summary').textContent = 'Performance data not available.';
            return;
        }
        renderPerfSummary(data);
        renderPerfChart(data);
    })
    .catch(function() {
        document.getElementById('perf-summary').textContent = 'Performance data not available.';
    });

function renderPerfSummary(data) {
    var el = document.getElementById('perf-summary');
    var n = data.observations || 0;
    var corr = data.score_return_correlation;

    if (n === 0) {
        el.textContent = 'No historical snapshot data available for this stock.';
        return;
    }

    var corrText = 'insufficient data for correlation';
    if (corr !== null) {
        if (corr > 0.3) corrText = 'positively correlate (r = ' + corr.toFixed(2) + ')';
        else if (corr > 0.1) corrText = 'weakly positively correlate (r = ' + corr.toFixed(2) + ')';
        else if (corr > -0.1) corrText = 'show no clear correlation (r = ' + corr.toFixed(2) + ')';
        else if (corr > -0.3) corrText = 'weakly negatively correlate (r = ' + corr.toFixed(2) + ')';
        else corrText = 'negatively correlate (r = ' + corr.toFixed(2) + ')';
    }

    var avgRet = data.avg_return_1m !== null ? ' | Avg 1m return: ' + (data.avg_return_1m * 100).toFixed(1) + '%' : '';
    el.textContent = 'Based on ' + n + ' historical snapshots, score changes ' + corrText + '.' + avgRet;
}

function renderPerfChart(data) {
    var canvas = document.getElementById('perfChart');
    if (!canvas || !data.score_dates || data.score_dates.length === 0) return;

    var barColors = data.forward_returns_1m.map(function(v) {
        if (v === null) return 'rgba(156,163,175,0.5)';
        return v >= 0 ? 'rgba(22,163,74,0.6)' : 'rgba(220,38,38,0.6)';
    });

    new Chart(canvas, {
        type: 'bar',
        data: {
            labels: data.score_dates,
            datasets: [
                {
                    label: '1m Forward Return',
                    data: data.forward_returns_1m,
                    backgroundColor: barColors,
                    borderColor: barColors,
                    borderWidth: 1,
                    yAxisID: 'y1',
                    order: 2
                },
                {
                    label: 'Composite Score',
                    data: data.composite_scores,
                    type: 'line',
                    borderColor: '#1a1d23',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHitRadius: 8,
                    tension: 0.2,
                    yAxisID: 'y',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 10, font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            if (ctx.dataset.yAxisID === 'y1') {
                                return ctx.parsed.y !== null ? '1m Return: ' + (ctx.parsed.y * 100).toFixed(1) + '%' : '1m Return: N/A';
                            }
                            return 'Score: ' + ctx.parsed.y.toFixed(1);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(val, i) {
                            var d = this.getLabelForValue(val);
                            return d.substring(5); /* MM-DD */
                        }
                    },
                    grid: { display: false }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 100,
                    ticks: { stepSize: 25 },
                    title: { display: true, text: 'Composite Score', font: { size: 11 } }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: {
                        callback: function(val) { return (val * 100).toFixed(0) + '%'; }
                    },
                    title: { display: true, text: '1m Forward Return', font: { size: 11 } },
                    grid: { drawOnChartArea: false }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}
</script>
{% endblock %}
